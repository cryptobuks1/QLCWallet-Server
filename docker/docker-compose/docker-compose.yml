version: "3.5"

services:
  postgresql:
    image: postgres:alpine
    container_name: postgresql
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - qlcwallet
    environment:
      - POSTGRES_USER=qlc
      - POSTGRES_DB=qlcwallet
      - POSTGRES_PASSWORD=SHOULD_BE_CHANGED
    volumes:
      # - type: bind
      #   source: ./mysql/conf.d
      #   target: /etc/mysql/conf.d
      - type: bind
        source: ./postgresql/data
        target: /var/lib/postgresql/data
    secrets:
      - db_root_password
    restart: always

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      - qlcwallet
    restart: always

  qlcchain_node:
    image: qlcchain-node:latest
    container_name: qlcchain_node
    ports:
      - "29734:29734/udp"
      - "29734:29734"
      - "127.0.0.1:29735:29735"
    networks:
      - qlcwallet
    volumes:
      - type: bind
        source: ./qlc_node/QLCChain
        target: /root/QLCChain
    restart: always

  qlc_wallet_server:
    image: qlcwallet-server:latest
    container_name: qlc_wallet_server
    ports:
      - "8888:8888"
      - "3000:3000"
    networks:
      - qlcwallet
      - traefik
    volumes:
      - type: bind
        source: ./wallet-server/.env
        target: /app/config/.env
      - type: bind
        source: ./wallet-server/logs
        target: /var/log/wallet-server
    depends_on: 
        - postgresql
        - redis
        - qlcchain_node
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.backend=qlc_wallet_server"
      - "traefik.first.port=8888"
      - "traefik.first.frontend.rule=Host:api.qlcchain.online"  
      - "traefik.second.port=3000"
      - "traefik.second.frontend.rule=Host:ws.qlcchain.online" 
      - "traefik.docker.network=traefik"

#   traefik:
#     hostname: traefik
#     image: traefik:latest
#     container_name: traefik
#     restart: always
#     domainname: qlcchain.online
#     networks:
#       - default
#       - traefik
#     ports:
#       - "80:80"
#       - "443:443"
#       - "8080:8080"
#     environment:
#       - CLOUDFLARE_EMAIL=
#       - CLOUDFLARE_API_KEY=
#     labels:
#       - "traefik.enable=true"
#       - "traefik.backend=traefik"
#       - "traefik.frontend.rule=Host:traefik.qlcchain.online"  
# #      - "traefik.frontend.rule=Host:${DOMAINNAME}; PathPrefixStrip: /traefik"
#       - "traefik.port=8080"
#       - "traefik.docker.network=traefik"
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock:ro
#       - ./traefik:/etc/traefik
#       - ./shared:/shared

secrets:
  db_root_password:
    file: ./postgresql/db_secret.txt

networks:
  qlcwallet:
    name: qlcwallet
  traefik:
    name: traefik_proxy